# ADR-002: Защита эндпоинта аутентификации от подбора пароля (Rate Limiting)

Дата: 2025-10-22
Статус: Accepted

## Context
Эндпоинт `POST /api/v1/auth/login`, реализованный в `app/api/v1/endpoints/auth.py`, является критически важной точкой входа в систему. В текущей реализации, которая является моком, отсутствует какая-либо защита от автоматизированного подбора паролей (брутфорс). При внедрении реальной логики аутентификации эта уязвимость станет критической.

Отсутствие механизма, ограничивающего частоту неудачных попыток входа, создает высокий риск компрометации учетных записей. Этот риск задокументирован в модели угроз как **R1** и требует обязательного контроля согласно **NFR-04**.

## Decision
Внедрение механизма ограничения частоты запросов для эндпоинта `POST /api/v1/auth/login`.

Лимит будет применяться к комбинации IP-адреса и имени пользователя. Это позволяет предотвратить как распределённый подбор пароля для одного аккаунта, так и подбор паролей для разных аккаунтов с одного IP.

- Rate: 5 неудачных попыток в минуту.
- Поведение при превышении: При превышении лимита сервер будет отвечать HTTP-статусом `429 Too Many Requests`. Ответ будет содержать заголовок `Retry-After`, указывающий на длительность блокировки в 15 минут, в течение которой повторные попытки для данной комбинации `ip:username` будут отклоняться.

## Consequences
**Плюсы:**
- Значительное снижение риска R1, атаки методом перебора становятся неэффективными.
- Соответствие NFR-04.
- Позволяет собирать метрики по заблокированным попыткам, что является сигналом о потенциальной атаке.

**Минусы:**
- Неправильно настроенные пороги или использование одного IP-адреса многими пользователями (например, за NAT) может привести к временной блокировке. Выбранный ключ `ip:username` частично смягчает эту проблему.
- Для масштабирования, может потребоваться внешнее хранилище состояний, что усложняет инфраструктуру.

## Alternatives
1.  **Блокировка учётной записи.**
    * Описание: После N неудачных попыток аккаунт пользователя блокируется на определённое время или до ручной разблокировки администратором.
    * Плюсы: Эффективно останавливает целевую атаку на конкретный аккаунт.
    * Минусы: Создаёт возможность для DoS. Злоумышленник может намеренно заблокировать легитимных пользователей, зная их логины. Это неприемлемый бизнес-риск.
2.  **Использование CAPTCHA.**
    * Описание: После нескольких неудачных попыток требовать от пользователя прохождения теста CAPTCHA.
    * Плюсы: Эффективно против большинства простых ботов.
    * Минусы: Резко ухудшает пользовательский опыт. Что более важно, это решение неприменимо для нашего API, так как он должен поддерживать неинтерактивных клиентов (CLI, сторонние сервисы), которые не могут пройти CAPTCHA.

## Definition of Done (DoD)
- Реализация: Логика ограничения частоты запросов реализована в `app/api/ratelimit.py` и применяется к эндпоинту `POST /login` через механизм зависимостей FastAPI.
- Тестирование:
    - Автоматический тест `tests/test_auth.py::test_login_blocks_after_too_many_failed_attempts` успешно проходит:
        - Первые 5 неудачных попыток возвращают код `401 Unauthorized`.
        - 6-я неудачная попытка возвращает код `429 Too Many Requests`.
        - Ответ `429` содержит заголовок `Retry-After`.
- CI: Все тесты в CI-пайплайне успешно проходят.

## Links
- **NFR:** NFR-04 (Брут-форс защита логина).
- **Threat Model:** Риск R1 (Компрометация через брутфорс), Поток F1 (Auth Requests).
- **Тесты:** `tests/test_auth.py::test_login_rate_limit_applied`, `tests/test_auth.py::test_login_rate_limit_resets_after_timeout`
