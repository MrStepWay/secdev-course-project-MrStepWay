# ADR-001: Стандартизация формата ошибок API в соответствии с RFC 7807

Дата: 2025-10-22
Статус: Accepted

## Context
В настоящее время проект использует кастомные обработчики исключений, определенные в файле `app/core/exceptions.py`. Эти обработчики (`http_exception_handler`, `validation_exception_handler`) возвращают ошибки в собственном формате, например: `{"error": {"code": "not_found", "message": "Project not found"}}`.

Для построения надёжного и удобного для потребителей API необходим единый, предсказуемый и расширяемый формат ошибок. Стандартный формат упрощает интеграцию для клиентов и позволяет использовать готовые инструменты для парсинга и обработки ошибок.

Кроме того, для эффективного расследования инцидентов и отладки, каждый запрос, особенно ошибочный, должен быть однозначно трассируем в системе логирования. Это требует наличия уникального идентификатора корреляции, который связывает ошибку, полученную клиентом, с детальной информацией в логах сервера.

## Decision
Мы внедряем для ответов об ошибках формат `application/problem+json`, описанный в **RFC 7807**. Этот стандарт предоставляет структуру для сообщений об ошибках HTTP API.

Каждый ответ об ошибке будет содержать как минимум следующие поля:
- `type` (string): URI, идентифицирующий тип проблемы. Для начала будет использоваться `about:blank`.
- `title` (string): Краткое, удобочитаемое описание типа проблемы.
- `status` (number): HTTP-статус код, отраженный в ответе.
- `detail` (string): Человекочитаемое объяснение конкретно этого вхождения проблемы.
- `correlation_id` (string): Уникальный идентификатор (UUID), присвоенный запросу, для трассировки в логах.

Обработчики исключений в приложении будут генерировать ответы строго в этом формате.

## Consequences
**Плюсы:**
- Стандартизация
- Улучшенная наблюдаемость (наличие `correlation_id` в каждом ответе об ошибке и соответствующих логах)
- Расширяемость (позволяет добавлять кастомные поля)

**Минусы:**
- Ответы станут чуть больше.

## Alternatives
1.  **Оставить существующий кастомный формат.**
    * Описание: Продолжать использовать формат `{"error": {"code": "...", "message": "..."}}`.
    * Плюсы: Не требует никаких изменений в коде. Формат очень простой.
    * Минусы: Не является отраслевым стандартом, что усложняет жизнь потребителям API. Не решает проблему отсутствия `correlation_id` без дальнейшей кастомизации.
2.  **Расширить существующий формат, добавив `correlation_id`.**
    * Описание: Вместо перехода на новый стандарт, можно было бы просто добавить недостающее поле в текущую структуру. Ответ выглядел бы так: `{"error": {"code": "...", "message": "..."}, "correlation_id": "..."}`.
    * Плюсы: Очень простое и быстрое в реализации изменение. Решает проблему трассируемости запросов. Сохраняет частичную обратную совместимость.
    * Минусы: Формат по-прежнему остаётся нестандартным. Это упускает возможность привести API к общепринятому виду, что в долгосрочной перспективе улучшает итеграции проекта.

## Links
- **NFR:** NFR-05 (Маскирование чувствительных данных в логах - `correlation_id` помогает избежать передачи деталей в ответе), NFR-06 (Аудит событий - `correlation_id` связывает событие с конкретным запросом).
- **Threat Model:** R2 (Утечка данных через логи - `correlation_id` позволяет логировать детали на сервере, не отправляя их клиенту).
- **Тесты:** `tests/test_errors.py::test_error_format_rfc7807`