# ADR-003: Централизованное управление секретами с помощью HashiCorp Vault

Дата: 2025-10-22
Статус: Accepted

## Context
В данный момент конфигурация, включая секрет `DATABASE_URL`, считывается из переменных окружения с помощью `pydantic-settings` в `app/core/config.py`. Для локальной разработки используется `.env` файл, что является приемлемой практикой.

Для производственной среды (production/staging) хранение секретов в `.env` файлах или их прямая передача в `docker-compose.yml` небезопасно и не масштабируемо. С добавлением новых функций количество секретов (ключи подписи, ключи API) будет расти.

## Decision
Мы принимаем **HashiCorp Vault** в качестве единого, централизованного хранилища для всех секретов приложения.

Процесс, запускающий приложение, будет отвечать за аутентификацию в Vault, извлечение необходимых секретов и их экспорт в виде переменных окружения для основного процесса приложения.Это полностью отделяет логику приложения от хранилища секретов. Код в `app/core/config.py` остаётся простым и продолжает читать конфигурацию из окружения, не зная о существовании Vault.

Для локального окружения в `docker-compose.yml` будет добавлен сервис с Vault, работающий в `dev-mode`. Это предоставит полнофункциональный, но легковесный инстанс Vault.

## Consequences
**Плюсы:**
- Все секреты хранятся в одном зашифрованном месте с строгим контролем доступа.
- Vault предоставляет детальные логи аудита, фиксирующие кто, что и когда запрашивал. Это критически важно для соответствия NFR-06 и расследования инцидентов.
- Основа для использования продвинутых функций Vault в будущем, например, динамические секреты (временные креды для БД) и автоматическая ротация ключей.

**Минусы:**
- Требуется развертывание и поддержка дополнительного компонента (Vault). Локальная разработка усложняется необходимостью запускать еще один контейнер.
- В проде Vault должен быть развернут в отказоустойчивой конфигурации, так как его недоступность может помешать запуску или работе приложения.

## Alternatives
1.  **Использование зашифрованных файлов в Git-репозитории.**
    * Описание: Секреты коммитятся в репозиторий в зашифрованном виде. Ключ для расшифровки доступен только в CI/CD окружении.
    * Плюсы: Секреты версионируются вместе с кодом; простая первоначальная настройка.
    * Минусы: Отсутствует централизованный аудит доступа к секретам. Ротация ключей — сложный процесс. Высокий риск компометации, если ключ для расшифровки будет украден из CI.
2.  **Использование встроенных средств оркестратора (Docker Secrets).**
    * Описание: Использовать `docker secret` для монтирования секретов в контейнер как файлы или переенные окжения.
    * Плюсы: Глубокая интеграция со средой развертывания, не требует внешних зависимостей.
    * Минусы: Создаёт сильную привязку к платформе. Не так удобно, как vault.

## Links
- **NFR:** NFR-05 (Маскирование чувствительных данных), NFR-06 (Аудит событий аутентификации - Vault логирует доступ к секретам).
- **Threat Model:** F5 (Configuration), R2 (Утечка чувствительных данных), R6 (Компрометация БД).